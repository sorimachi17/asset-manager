<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>資産管理アプリ</title>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#111;--fg:#e8ecf1;--muted:#9aa4b2;--card:#1a1a1a;--line:#262a34;
      --panel:#151618;--grid:rgba(255,255,255,.14);--accent:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;max-width:100%;overflow-x:hidden}
    header{border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(17,17,17,.9);backdrop-filter:saturate(120%) blur(6px)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px 0;font-size:20px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="file"]{padding:8px;background:var(--card);border:1px solid var(--line);border-radius:10px}
    button{background:#1a5fff;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    main{display:grid;gap:16px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .big{font-size:22px;font-weight:700;margin-top:6px}
    .sub{font-size:12px;color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    h2{margin:0 0 6px 0;font-size:16px}
    .h2-sub{margin-top:-2px;font-size:12px;color:var(--muted)}
    select, input[type="date"], input[type="month"]{background:#0e121a;border:1px solid var(--line);color:var(--fg);padding:8px;border-radius:10px}
    .legend-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0}
    .chart-wrap{background:#1b1b1b;border:1px solid var(--line);border-radius:12px;padding:10px}

    /* ===== Calendar (responsive + grass) ===== */
    .cal-header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .cal-nav{display:flex;align-items:center;gap:8px}
    .icon-btn{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#1b1b1b;color:#cfd6e4;cursor:pointer}
    .cal-title{font-size:18px;font-weight:600}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;width:100%}
    .weekday{font-size:12px;color:var(--muted);text-align:center;margin-bottom:6px}
    .day-cell{
      background:#1c1f25;border:1px solid #2a2f3a;border-radius:12px;
      padding:8px;display:flex;flex-direction:column;gap:4px;cursor:pointer;
      aspect-ratio:1/1; /* 正方形 */
      min-width:0; /* overrun防止 */
    }
    .day-cell.disabled{opacity:.35;cursor:default}
    .day-cell:hover{border-color:#3b4252}
    .day-head{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .day-num{font-size:12px;line-height:1;color:#c9ced6;flex:0 0 auto}
    .day-total{font-size:12px;line-height:1;color:#c9d7ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .day-delta{font-size:11px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .selected{outline:2px solid var(--accent); outline-offset:-2px}
    .cal-detail{margin-top:12px;background:#1b1b1b;border:1px solid var(--line);border-radius:12px;padding:14px}
    .detail-title{font-size:16px;font-weight:600;margin:0 0 8px 0}

    /* grass colors: 最新日との差（増:緑系 / 減:赤系）5段階 */
    .up1{background:#0e4429}.up2{background:#006d32}.up3{background:#26a641}.up4{background:#39d353}.up5{background:#63d353}
    .dn1{background:#fee2e2}.dn2{background:#fecaca}.dn3{background:#fca5a5}.dn4{background:#f87171}.dn5{background:#ef4444}
    .eq{background:#1e2638}
    .day-cell.plus{background:rgba(34,197,94,.15);border-color:#22c55e;}
    .day-cell.minus{background:rgba(239,68,68,.15);border-color:#ef4444;}

    /* mobile tuning */
    @media (max-width:600px){
      .wrap{padding:12px}
      .cal-grid{gap:4px}
      .day-cell{padding:6px}
      .weekday{font-size:11px}
      .cal-title{font-size:16px}
      .kpi{grid-template-columns:1fr}
      .day-total{font-size:10px}
      .day-delta{font-size:9px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>資産管理アプリ</h1>
    <div class="toolbar">
      <input id="file" type="file" accept=".csv" />
      <span class="muted">「CSVを読み込む」→ 集計・可視化します</span>
      <button id="exportCsv" disabled>CSV書き出し</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- KPI -->
  <section class="kpi" id="kpis">
    <div class="card">
      <div class="muted">評価総額 <span id="kpiDateLabel"></span></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
        <input type="date" id="totalDate"/>
      </div>
      <div class="big" id="totalValue">—</div>
    </div>

    <div class="card">
      <div class="muted">前日比 <span id="dodBase"></span></div>
      <div class="sub" id="dodCurSum">—</div>
      <div class="big" id="dod">—</div>
      <div class="sub" id="dodBaseSum" style="margin-top:4px"></div>
    </div>

    <div class="card">
      <div class="muted">月間増減 <span id="momBase"></span></div>
      <div class="sub" id="momCurSum">—</div>
      <div class="big" id="mom">—</div>
      <div class="sub" id="momBaseSum" style="margin-top:4px"></div>
    </div>
  </section>

  <!-- 資産分類 -->
  <section class="panel">
    <h2>資産分類</h2>
    <div class="h2-sub" id="pieDateNote">—</div>
    <div class="controls">
      <label>区分:
        <select id="pieDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
    </div>
    <div class="chart-wrap"><canvas id="pieChart" height="200"></canvas></div>
    <div class="legend-row" id="pieLegend"></div>
  </section>

  <!-- 日別推移（折れ線・期間指定） -->
  <section class="panel">
    <h2>日別推移</h2>
    <div class="h2-sub" id="lineRangeNote">—</div>
    <div class="controls">
      <label>区分:
        <select id="lineDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
      <label>期間: <input type="date" id="fromDate"> ～ <input type="date" id="toDate"></label>
      <button id="applyRange">反映</button>
    </div>
    <div class="chart-wrap"><canvas id="lineChart" height="300"></canvas></div>
    <div class="muted">※ 期間内の記録日のみ表示（点マーカーは常時非表示）</div>
  </section>

  <!-- 2日間比較 -->
  <section class="panel">
    <h2>2日間比較</h2>
    <div class="h2-sub">指定した2日間のカテゴリ別の総額を比較します</div>
    <div class="controls">
      <label>区分:
        <select id="cmpDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
      <label>日付A: <input type="date" id="cmpDateA"></label>
      <label>日付B: <input type="date" id="cmpDateB"></label>
      <button id="applyCmp">比較</button>
    </div>
    <div class="chart-wrap"><canvas id="cmpChart" height="280"></canvas></div>
    <div class="muted" id="cmpNote">—</div>
  </section>

  <!-- 月カレンダー（スマホ対応＋草） -->
  <section class="panel">
    <h2>月カレンダー</h2>
    <div class="cal-header">
      <div class="cal-nav">
        <button id="calPrev" class="icon-btn" aria-label="前の月"><</button>
        <div class="cal-title" id="calTitle">—</div>
        <button id="calNext" class="icon-btn" aria-label="次の月">></button>
      </div>
    </div>

    <div class="cal-grid" style="margin-bottom:4px">
      <div class="weekday">月</div><div class="weekday">火</div><div class="weekday">水</div>
      <div class="weekday">木</div><div class="weekday">金</div><div class="weekday">土</div><div class="weekday">日</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>

    <div class="cal-detail">
      <p class="detail-title" id="calDetailDate">—</p>
      <div id="calDetailBody">記録なし</div>
    </div>
  </section>
</main>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);

// --- state ---
let RAW = []; let DATES = []; const byDate = new Map();

// --- helpers ---
const $ = id => document.getElementById(id);
const yen = n => '¥' + new Intl.NumberFormat('ja-JP').format(Math.round(n ?? 0));
const fmt = n => new Intl.NumberFormat('ja-JP').format(Math.round(n ?? 0));
const COLORS = ['#3b82f6','#f59e0b','#10b981','#ef4444','#8b5cf6','#14b8a6','#eab308','#ec4899','#6366f1','#06b6d4'];
function normalizeDate(v){
  if(!v) return '';
  if(/年|月|日/.test(v)){ return dayjs(v.replace(/[年月]/g,'-').replace('日',''), ['YYYY-M-D','YYYY-MM-DD']).format('YYYY-MM-DD'); }
  return dayjs(v, ['YYYY-M-D','YYYY/MM/DD','YYYY-MM-DD']).format('YYYY-MM-DD');
}
function nearestOnOrBefore(target){
  if(!target || !DATES.length) return null;
  for(let i = DATES.length-1; i >= 0; i--){ if(DATES[i] <= target) return DATES[i]; }
  return null;
}
// 金額の簡略表記（万/億/兆、符号つき）
function compactJPY(n){
  const sign = n<0?'-':'';
  const v = Math.abs(n);
  if(v>=1e12)  return sign + (v/1e12).toFixed(v%1e12?1:0) + '兆';
  if(v>=1e8)   return sign + (v/1e8 ).toFixed(v%1e8 ?1:0) + '億';
  if(v>=1e4)   return sign + Math.round(v/1e4).toLocaleString('ja-JP') + '万';
  return sign + Math.round(v).toLocaleString('ja-JP');
}

function parseCSV(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  RAW = parsed.data.map(r => ({
    Date: normalizeDate(r.Date),
    Name: (r.Name||'').trim(),
    Amount: Number(String(r.Amount||'0').replace(/,/g,''))||0,
    AssetClass: (r.AssetClass||'').trim(),
    Currency: (r.Currency||'').trim(),
    StockType: (r.StockType||'').trim(),
    Account: (r.Account||'').trim()
  })).filter(r=>r.Date);
  buildIndexes(); onDataReady(); $("exportCsv").disabled = RAW.length===0;
}
function buildIndexes(){
  byDate.clear(); DATES = [];
  for(const r of RAW){ if(!byDate.has(r.Date)){ byDate.set(r.Date, []); DATES.push(r.Date); } byDate.get(r.Date).push(r); }
  DATES.sort();
}
function sumAt(date){ return (byDate.get(date)||[]).reduce((s,r)=>s+r.Amount,0); }
function computeClosestPrev(date){ const i = DATES.indexOf(date); return (i>0)? DATES[i-1] : null; }
function computeMonthBase(curDate){ const t = dayjs(curDate).subtract(1,'month').format('YYYY-MM-DD'); return nearestOnOrBefore(t); }

// ---------- KPIs ----------
function refreshKPIs(){
  if(!DATES.length){ ["kpiDateLabel","totalValue","dod","dodCurSum","dodBaseSum","mom","momCurSum","momBaseSum"].forEach(id=>$(id).textContent='—'); $("dodBase").textContent=''; $("momBase").textContent=''; return; }
  const picker = $("totalDate").value || DATES.at(-1);
  const curDate = nearestOnOrBefore(picker) || DATES.at(-1);
  const curVal  = sumAt(curDate);
  $("kpiDateLabel").textContent = `（${curDate} 時点）`;
  $("totalValue").textContent   = yen(curVal);

  const prevDate = computeClosestPrev(curDate);
  $("dodBase").textContent   = prevDate ? `基準: ${prevDate}` : '';
  $("dod").textContent       = prevDate ? ((curVal - sumAt(prevDate) >= 0 ? '+' : '') + yen(curVal - sumAt(prevDate))) : '—';
  $("dodCurSum").textContent = `当日総額: ${yen(curVal)}`;
  $("dodBaseSum").textContent= prevDate ? `基準総額: ${yen(sumAt(prevDate))}` : '';

  const monthBase = computeMonthBase(curDate);
  $("momBase").textContent   = monthBase ? `基準: ${monthBase}` : '基準: —';
  $("mom").textContent       = monthBase ? ((curVal - sumAt(monthBase) >= 0 ? '+' : '') + yen(curVal - sumAt(monthBase))) : '—';
  $("momCurSum").textContent = `当日総額: ${yen(curVal)}`;
  $("momBaseSum").textContent= monthBase ? `基準総額: ${yen(sumAt(monthBase))}` : '';
}

// ---------- Pie ----------
let pieChart;
function drawPie(){
  if(!DATES.length) return;
  const picker = $("totalDate").value || DATES.at(-1);
  const selDate = nearestOnOrBefore(picker) || DATES.at(-1);
  $("pieDateNote").textContent = `${selDate} 時点`;
  const dim = $("pieDimension").value;
  const rows = byDate.get(selDate) || [];
  const bucket = new Map();
  for(const r of rows){ const k = r[dim] || '(blank)'; bucket.set(k, (bucket.get(k)||0) + r.Amount); }
  const labels = [...bucket.keys()], data=[...bucket.values()];
  if(pieChart) pieChart.destroy();
  pieChart = new Chart($("pieChart"), {
    type:'doughnut',
    data:{labels, datasets:[{data}]},
    options:{plugins:{legend:{display:false}, tooltip:{callbacks:{label: ctx => `${ctx.label}: ${yen(ctx.parsed)}`}}}}
  });
  $("pieLegend").innerHTML = labels.map((k,i)=>{
    const c = pieChart.getDatasetMeta(0).controller.getStyle(i,false).backgroundColor;
    return `<span class="legend-item"><span class="dot" style="background:${c}"></span>${k}</span>`;
  }).join('');
}

// ---------- Line ----------
let lineChart;
function drawLine(){
  if(!DATES.length) return;
  const dim = $("lineDimension").value;
  const from = $("fromDate").value ? nearestOnOrBefore($("fromDate").value) : DATES[0];
  const to   = nearestOnOrBefore($("toDate").value || DATES.at(-1)) || DATES.at(-1);
  const labels = DATES.filter(d => d>=from && d<=to);
  $("lineRangeNote").textContent = `${from} 〜 ${to}`;

  const set = new Set(); for(const d of labels){ for(const r of (byDate.get(d)||[])){ set.add(r[dim]||'(blank)'); } }
  const cats = [...set].sort();
  const series = cats.map(c => labels.map(d => (byDate.get(d)||[]).filter(r => (r[dim]||'(blank)')===c).reduce((s,r)=>s+r.Amount,0)));
  const totals = labels.map(d=> sumAt(d));

  if(lineChart) lineChart.destroy();
  lineChart = new Chart($("lineChart"), {
    type:'line',
    data:{labels,
      datasets:[
        ...cats.map((c,i)=>({
          label:c,
          data:series[i],
          tension:0.35,
          borderWidth:1.5,
          fill:false,
          pointRadius:0,
          pointHitRadius:8,
          borderColor:COLORS[i%COLORS.length],
          backgroundColor:COLORS[i%COLORS.length]
        })),
        {label:'合計',data:totals,borderColor:'#fff',borderWidth:3,tension:0.35,pointRadius:0,pointHitRadius:10,order:-1}
      ]},
    options:{
      responsive:true,
      scales:{x:{grid:{color:'rgba(255,255,255,0.14)'},ticks:{color:'#cfd6e4',autoSkip:true,maxTicksLimit:12}},
              y:{grid:{color:'rgba(255,255,255,0.14)'},ticks:{color:'#cfd6e4',callback:(v)=>'¥'+fmt(v)}}},
      plugins:{legend:{position:'bottom',labels:{color:'#e8ecf1'}},tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${yen(ctx.parsed.y)}`}}}
    }
  });
}

// ---------- 2日比較 ----------
let cmpChart;
function drawCmp(){
  if(!DATES.length) return;
  let a = nearestOnOrBefore($("cmpDateA").value || DATES.at(-1)) || DATES.at(-1);
  let b = nearestOnOrBefore($("cmpDateB").value || DATES.at(-1)) || DATES.at(-1);
  const dim = $("cmpDimension").value;
  const set = new Set();
  for(const r of (byDate.get(a)||[])) set.add(r[dim]||'(blank)');
  for(const r of (byDate.get(b)||[])) set.add(r[dim]||'(blank)');
  const cats = [...set];
  const sumBy = (d,c)=> (byDate.get(d)||[]).filter(r=>(r[dim]||'(blank)')===c).reduce((s,r)=>s+r.Amount,0);
  const valsA = cats.map(c=>sumBy(a,c)), valsB = cats.map(c=>sumBy(b,c));
  if(cmpChart) cmpChart.destroy();
  cmpChart = new Chart($("cmpChart"), {
    type:'bar', data:{labels:cats, datasets:[
      {label:a, data:valsA, backgroundColor:COLORS[0], borderColor:COLORS[0]},
      {label:b, data:valsB, backgroundColor:COLORS[1], borderColor:COLORS[1]}
    ]},
    options:{plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${yen(ctx.parsed.y)}`}}},
             scales:{x:{grid:{color:'rgba(255,255,255,.14)'}},y:{grid:{color:'rgba(255,255,255,.14)'},ticks:{callback:v=>'¥'+fmt(v)}}}}
  });
  const ta = valsA.reduce((s,v)=>s+v,0), tb = valsB.reduce((s,v)=>s+v,0);
  $("cmpNote").textContent = `合計: ${a} = ${yen(ta)} / ${b} = ${yen(tb)}（差分: ${(tb-ta>=0?'+':'')+yen(tb-ta)}）`;
}

// ---------- Calendar (スマホ対応＋草) ----------
const calState = { month:null, selected:null };

function initCalendarDefaults(){
  const last = DATES.at(-1) || dayjs().format('YYYY-MM-DD');
  calState.month = last.slice(0,7);
  calState.selected = last;
}

function renderCalendar(){
  if(!DATES.length){
    $("calTitle").textContent='—'; $("calGrid").innerHTML=''; $("calDetailDate").textContent='—'; $("calDetailBody").textContent='記録なし'; return;
  }
  const ym = calState.month;
  const base = dayjs(ym+'-01');
  $("calTitle").textContent = base.format('YYYY年M月');

  // 最新日（基準）との差で色分け
  const latest = DATES.at(-1);
  const latestTotal = sumAt(latest);

  // 6週固定グリッド
  const firstDowMon0 = (base.day()+6)%7; // 月=0
  const start = base.subtract(firstDowMon0,'day');
  const cells = Array.from({length:42},(_,i)=> start.add(i,'day'));

  // 当月内のabs差分からしきい値（分位）
  const monthDays = cells.filter(d=>d.month()===base.month()).map(d=>d.format('YYYY-MM-DD'));
  const diffsAbs = monthDays.map(d=> Math.abs((byDate.has(d)? sumAt(d):latestTotal) - latestTotal));
  const sorted = diffsAbs.filter(v=>v>0).sort((a,b)=>a-b);
  const q = p => (sorted.length? sorted[Math.floor((sorted.length-1)*p)] : 0);
  const t1=q(0.2), t2=q(0.4), t3=q(0.6), t4=q(0.8);

  const grid = $("calGrid"); grid.innerHTML = '';
  for(const d of cells){
    const ymd = d.format('YYYY-MM-DD');
    const inMonth = d.month()===base.month();
    const cell = document.createElement('div');
    cell.className = 'day-cell' + (inMonth?'':' disabled');
    if(ymd===calState.selected) cell.classList.add('selected');

      // 草カラー：最新との差（増:緑系 / 減:赤系）
      const total = byDate.has(ymd)? sumAt(ymd) : latestTotal;
      const diff  = latestTotal - total; // 正:最新より増加
      let cls = '';
      if(byDate.has(ymd) && diff === 0){
        cls = 'eq';
      }else{
        const a = Math.abs(diff);
        let level = ''; // up1..5 / dn1..5
        if(a>0 && a<=t1) level='1'; else if(a>t1 && a<=t2) level='2'; else if(a>t2 && a<=t3) level='3'; else if(a>t3 && a<=t4) level='4'; else if(a>t4) level='5';
        if(level) cls = diff>0?('up'+level):('dn'+level);
      }
      if(cls) cell.classList.add(cls);

    // 表示
    const head = document.createElement('div'); head.className='day-head';
    const num = document.createElement('div');  num.className='day-num'; num.textContent = String(d.date());
    const totalEl = document.createElement('div'); totalEl.className='day-total'; totalEl.textContent = byDate.has(ymd)? compactJPY(total) : '';
    head.appendChild(num); head.appendChild(totalEl);
    cell.appendChild(head);

    const deltaEl = document.createElement('div'); deltaEl.className='day-delta';
    if(byDate.has(ymd)){
      const idx = DATES.indexOf(ymd); const prev = idx>0? DATES[idx-1] : null;
      if(prev){
        const dv = sumAt(ymd)-sumAt(prev);
        deltaEl.textContent = (dv>=0?'+':'') + compactJPY(dv);
        const isPlus = dv >= 0;
        deltaEl.style.color = isPlus ? '#22c55e' : '#ef4444';
        cell.classList.add(isPlus ? 'plus' : 'minus');
      }
    }
    if(deltaEl.textContent) cell.appendChild(deltaEl);

    cell.addEventListener('click', ()=>{ if(!inMonth) return; calState.selected = ymd; renderCalendarDetail(); renderCalendar(); });
    grid.appendChild(cell);
  }

  if(calState.selected.slice(0,7)!==ym){
    const firstInMonth = DATES.find(x=>x.startsWith(ym)) || ym+'-01';
    calState.selected = firstInMonth;
  }
  renderCalendarDetail();
}

function renderCalendarDetail(){
  const d = calState.selected;
  $("calDetailDate").textContent = d;
  if(!byDate.has(d)){ $("calDetailBody").textContent = '記録なし'; return; }
  const total = sumAt(d);
  const idx = DATES.indexOf(d);
  const prev = computeClosestPrev(d);
  const delta = prev ? (total - sumAt(prev)) : null;
  const deltaStr = delta===null ? '—' : ((delta>=0?'+':'')+yen(delta));
  const deltaColor = delta===null ? '' : (delta>=0 ? '#22c55e' : '#ef4444');

  // 金額が0円の銘柄は表示しない
  const rows = byDate.get(d)
    .filter(r => r.Amount !== 0)
    .sort((a,b)=>a.Name.localeCompare(b.Name));
  const detailLines = rows.map(r=>{
    const prevAmt = prev
      ? ((byDate.get(prev) || []).find(x=>x.Name === r.Name)?.Amount || 0)
      : null;
    const diff = prevAmt===null ? null : r.Amount - prevAmt;
    const diffStr = diff===null ? '—' : ((diff>=0?'+':'')+yen(diff));
    const diffColor = diff===null ? 'var(--muted)' : (diff>=0 ? '#22c55e' : '#ef4444');
    const ratio = (prevAmt===null || prevAmt===0) ? null : (diff / prevAmt * 100);
    const ratioStr = ratio===null ? ' (—%)' : ` (${ratio>=0?'+':''}${ratio.toFixed(2)}%)`;
    return `<div>${r.Name}: ${yen(r.Amount)} <span style="color:${diffColor}">${diffStr}${ratioStr}</span></div>`;
  }).join('');

  const summary = `総額：${yen(total)}<br/>前回比：<span style="color:${deltaColor}">${deltaStr}</span>${prev?`（前回: ${prev}）`:''}`;
  $("calDetailBody").innerHTML = summary + (detailLines ? `<hr style="margin:8px 0;border:1px solid var(--line)">${detailLines}` : '');
}

// ---------- Export ----------
function exportCsv(){
  if(RAW.length===0) return;
  const header = ['Date','Name','Amount','AssetClass','Currency','StockType','Account'];
  const rows = RAW.map(r=>header.map(h=>r[h]??'')); const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'assets_export.csv'; a.click(); URL.revokeObjectURL(url);
}

// ---------- lifecycle ----------
function onDataReady(){
  $("totalDate").value = DATES.at(-1) || '';
  $("fromDate").value  = DATES[0] || '';
  $("toDate").value    = DATES.at(-1) || '';
  $("cmpDateA").value  = DATES.at(-1) || '';
  $("cmpDateB").value  = DATES.at(-1) || '';
  refreshKPIs(); drawPie(); drawLine(); drawCmp();
  initCalendarDefaults(); renderCalendar();
}

// events
$("file").addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader(); reader.onload = ()=> parseCSV(reader.result); reader.readAsText(file);
});
$("exportCsv").addEventListener('click', exportCsv);
$("totalDate").addEventListener('change', ()=>{ refreshKPIs(); drawPie(); });
$("pieDimension").addEventListener('change', drawPie);
$("lineDimension").addEventListener('change', drawLine);
$("applyRange").addEventListener('click', drawLine);
$("cmpDimension").addEventListener('change', drawCmp);
$("applyCmp").addEventListener('click', drawCmp);
$("calPrev").addEventListener('click', ()=>{ calState.month = dayjs(calState.month+'-01').subtract(1,'month').format('YYYY-MM'); renderCalendar(); });
$("calNext").addEventListener('click', ()=>{ calState.month = dayjs(calState.month+'-01').add(1,'month').format('YYYY-MM'); renderCalendar(); });
</script>
</body>
</html>
