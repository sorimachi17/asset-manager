<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>資産管理アプリ</title>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#111;--fg:#e8ecf1;--muted:#9aa4b2;--card:#1a1a1a;--line:#262a34;
      --panel:#151618;--grid:rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    header{border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(17,17,17,.9);backdrop-filter:saturate(120%) blur(6px)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px 0;font-size:20px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="file"]{padding:8px;background:var(--card);border:1px solid var(--line);border-radius:10px}
    button{background:#1a5fff;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    main{display:grid;gap:16px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .big{font-size:22px;font-weight:700;margin-top:6px}
    .sub{font-size:12px;color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    h2{margin:0 0 6px 0;font-size:16px}
    .h2-sub{margin-top:-2px;font-size:12px;color:var(--muted)}
    select, input[type="date"], input[type="month"]{background:#0e121a;border:1px solid var(--line);color:var(--fg);padding:8px;border-radius:10px}
    .legend-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0}
    .chart-wrap{background:#1b1b1b;border:1px solid var(--line);border-radius:12px;padding:10px}
    /* calendar */
    table.calendar{width:100%;border-collapse:separate;border-spacing:6px}
    .cal-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-legend{display:flex;gap:6px;align-items:center}
    .cal-legend .cell{width:12px;height:12px;border-radius:2px}
    .cal{background:#1b1b1b;border:1px solid var(--line);border-radius:12px;padding:10px}
    th,td{vertical-align:top}
    th{color:var(--muted);font-weight:500}
    td.day{
      width:14.28%;min-height:90px;background:#141414;border:1px solid #202020;border-radius:10px;padding:8px;position:relative
    }
    .day .date{font-size:12px;color:#c9ced6}
    .day .total{font-size:11px;color:#9fb0ff;margin-top:2px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .day .delta{font-size:11px;color:#a6ffb1;margin-top:2px}
    .bg1{background:#101822}.bg2{background:#122238}.bg3{background:#132c49}.bg4{background:#173760}.bg5{background:#1a4577}
    @media (max-width:980px){.kpi{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>資産管理アプリ</h1>
    <div class="toolbar">
      <input id="file" type="file" accept=".csv" />
      <span class="muted">「CSVを読み込む」→ 集計・可視化します</span>
      <button id="exportCsv" disabled>CSV書き出し</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- KPI -->
  <section class="kpi" id="kpis">
    <div class="card">
      <div class="muted">評価総額 <span id="kpiDateLabel"></span></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
        <input type="date" id="totalDate"/>
      </div>
      <div class="big" id="totalValue">—</div>
    </div>

    <div class="card">
      <div class="muted">前日比 <span id="dodBase"></span></div>
      <div class="sub" id="dodCurSum">—</div>
      <div class="big" id="dod">—</div>
      <div class="sub" id="dodBaseSum" style="margin-top:4px"></div>
    </div>

    <div class="card">
      <div class="muted">月間増減 <span id="momBase"></span></div>
      <div class="sub" id="momCurSum">—</div>
      <div class="big" id="mom">—</div>
      <div class="sub" id="momBaseSum" style="margin-top:4px"></div>
    </div>
  </section>

  <!-- 資産分類（元: 比率ビュー） -->
  <section class="panel">
    <h2>資産分類</h2>
    <div class="h2-sub" id="pieDateNote">—</div>
    <div class="controls">
      <label>区分:
        <select id="pieDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
    </div>
    <div class="chart-wrap"><canvas id="pieChart" height="200"></canvas></div>
    <div class="legend-row" id="pieLegend"></div>
  </section>

  <!-- 日別推移（期間指定・折れ線） -->
  <section class="panel">
    <h2>日別推移</h2>
    <div class="h2-sub" id="lineRangeNote">—</div>
    <div class="controls">
      <label>区分:
        <select id="lineDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
      <label>期間: <input type="date" id="fromDate"> ～ <input type="date" id="toDate"></label>
      <button id="applyRange">反映</button>
    </div>
    <div class="chart-wrap"><canvas id="lineChart" height="300"></canvas></div>
    <div class="muted">※ 期間内の記録日のみ表示（点マーカーは常時非表示）</div>
  </section>

  <!-- 2日間比較ビュー -->
  <section class="panel">
    <h2>2日間比較</h2>
    <div class="h2-sub">指定した2日間のカテゴリ別の総額を比較します</div>
    <div class="controls">
      <label>区分:
        <select id="cmpDimension">
          <option value="AssetClass">AssetClass（資産分類）</option>
          <option value="Currency">Currency（通貨）</option>
          <option value="Name">Name（銘柄）</option>
          <option value="StockType">StockType（区分）</option>
          <option value="Account">Account（口座）</option>
        </select>
      </label>
      <label>日付A: <input type="date" id="cmpDateA"></label>
      <label>日付B: <input type="date" id="cmpDateB"></label>
      <button id="applyCmp">比較</button>
    </div>
    <div class="chart-wrap"><canvas id="cmpChart" height="280"></canvas></div>
    <div class="muted" id="cmpNote">—</div>
  </section>

  <!-- 月カレンダー（日別総額 + 前回比カラー） -->
  <section class="panel">
    <h2>月カレンダー</h2>
    <div class="controls cal-head">
      <div>
        <label>対象月: <input type="month" id="calMonth"></label>
      </div>
      <div class="cal-legend">
        <span class="muted">前回比 小</span>
        <div class="cell bg1"></div><div class="cell bg2"></div><div class="cell bg3"></div><div class="cell bg4"></div><div class="cell bg5"></div>
        <span class="muted">大</span>
      </div>
    </div>
    <div class="cal">
      <table class="calendar">
        <thead>
          <tr><th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th></tr>
        </thead>
        <tbody id="calBody"></tbody>
      </table>
    </div>
    <div class="muted" id="heatLatest">—</div>
  </section>
</main>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);

// --- state ---
let RAW = [];            // 元データ（行）
let DATES = [];          // 記録がある日（YYYY-MM-DD）
const byDate = new Map();// date -> rows

// --- helpers ---
const $ = id => document.getElementById(id);
const yen = n => '¥' + new Intl.NumberFormat('ja-JP').format(Math.round(n ?? 0));
const pct = (v, t) => (t ? (v/t*100) : 0).toFixed(1) + '%';
const fmt = n => new Intl.NumberFormat('ja-JP').format(Math.round(n ?? 0));

function normalizeDate(v){
  if(!v) return '';
  if(/年|月|日/.test(v)){
    return dayjs(v.replace(/[年月]/g,'-').replace('日',''), ['YYYY-M-D','YYYY-MM-DD']).format('YYYY-MM-DD');
  }
  return dayjs(v, ['YYYY-M-D','YYYY/MM/DD','YYYY-MM-DD']).format('YYYY-MM-DD');
}

function nearestOnOrBefore(target){
  if(!target || !DATES.length) return null;
  for(let i = DATES.length-1; i >= 0; i--){
    if(DATES[i] <= target) return DATES[i];
  }
  return null;
}

function parseCSV(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  RAW = parsed.data.map(r => ({
    Date: normalizeDate(r.Date),
    Name: (r.Name||'').trim(),
    Amount: Number(String(r.Amount||'0').replace(/,/g,''))||0,
    AssetClass: (r.AssetClass||'').trim(),
    Currency: (r.Currency||'').trim(),
    StockType: (r.StockType||'').trim(),
    Account: (r.Account||'').trim()
  })).filter(r=>r.Date);
  buildIndexes();
  onDataReady();
  $("exportCsv").disabled = RAW.length===0;
}

function buildIndexes(){
  byDate.clear(); DATES = [];
  for(const r of RAW){
    if(!byDate.has(r.Date)){ byDate.set(r.Date, []); DATES.push(r.Date); }
    byDate.get(r.Date).push(r);
  }
  DATES.sort();
}

function sumAt(date){ return (byDate.get(date)||[]).reduce((s,r)=>s+r.Amount,0); }

function computeClosestPrev(date){
  const idx = DATES.indexOf(date);
  return (idx>0) ? DATES[idx-1] : null;
}

function computeMonthBase(curDate){
  const target = dayjs(curDate).subtract(1,'month').format('YYYY-MM-DD');
  return nearestOnOrBefore(target);
}

// ---------- KPIs ----------
function refreshKPIs(){
  if(!DATES.length){
    $("kpiDateLabel").textContent='';
    $("totalValue").textContent='—';
    $("dod").textContent='—'; $("dodBase").textContent=''; $("dodCurSum").textContent='—'; $("dodBaseSum").textContent='';
    $("mom").textContent='—'; $("momBase").textContent=''; $("momCurSum").textContent='—'; $("momBaseSum").textContent='';
    return;
  }

  const picker = $("totalDate").value || DATES.at(-1);
  const curDate = nearestOnOrBefore(picker) || DATES.at(-1);
  const curVal  = sumAt(curDate);

  $("kpiDateLabel").textContent = `（${curDate} 時点）`;
  $("totalValue").textContent   = yen(curVal);

  // 前日比
  const prevDate = computeClosestPrev(curDate);
  $("dodBase").textContent = prevDate ? `基準: ${prevDate}` : '';
  $("dod").textContent     = prevDate ? ((curVal - sumAt(prevDate) >= 0 ? '+' : '') + yen(curVal - sumAt(prevDate))) : '—';
  $("dodCurSum").textContent = `当日総額: ${yen(curVal)}`;
  $("dodBaseSum").textContent = prevDate ? `基準総額: ${yen(sumAt(prevDate))}` : '';

  // 月間増減
  const monthBase = computeMonthBase(curDate);
  $("momBase").textContent = monthBase ? `基準: ${monthBase}` : '基準: —';
  $("mom").textContent     = monthBase ? ((curVal - sumAt(monthBase) >= 0 ? '+' : '') + yen(curVal - sumAt(monthBase))) : '—';
  $("momCurSum").textContent = `当日総額: ${yen(curVal)}`;
  $("momBaseSum").textContent = monthBase ? `基準総額: ${yen(sumAt(monthBase))}` : '';
}

// ---------- Pie（資産分類） ----------
let pieChart;
function drawPie(){
  if(!DATES.length) return;
  const picker = $("totalDate").value || DATES.at(-1);
  const selDate = nearestOnOrBefore(picker) || DATES.at(-1);
  const dim = $("pieDimension").value;
  $("pieDateNote").textContent = `${selDate} 時点`;

  const rows = byDate.get(selDate) || [];
  const bucket = new Map();
  for(const r of rows){
    const k = r[dim] || '(blank)';
    bucket.set(k, (bucket.get(k)||0) + r.Amount);
  }
  const labels = [...bucket.keys()];
  const data   = [...bucket.values()];

  if(pieChart) pieChart.destroy();
  pieChart = new Chart($("pieChart"), {
    type:'doughnut',
    data:{labels, datasets:[{data}]},
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{ label: ctx => `${ctx.label}: ${yen(ctx.parsed)}` }}
      }
    }
  });

  // 凡例（色と名前のみ）
  const colors = pieChart.data.datasets[0].backgroundColor || Chart.defaults.color;
  $("pieLegend").innerHTML = labels.map((k,i)=>{
    const c = pieChart.getDatasetMeta(0).controller.getStyle(i, false).backgroundColor;
    return `<span class="legend-item"><span class="dot" style="background:${c}"></span>${k}</span>`;
  }).join('');
}

// ---------- 日別推移（折れ線） ----------
let lineChart;
function drawLine(){
  if(!DATES.length) return;

  const dim = $("lineDimension").value;
  const from = $("fromDate").value ? nearestOnOrBefore($("fromDate").value) : DATES[0];
  const toRaw = $("toDate").value || DATES.at(-1);
  const to = nearestOnOrBefore(toRaw) || DATES.at(-1);
  const labels = DATES.filter(d => d>=from && d<=to);
  $("lineRangeNote").textContent = `${from} 〜 ${to}`;

  // カテゴリ集合
  const catSet = new Set();
  for(const d of labels){ for(const r of (byDate.get(d)||[])){ catSet.add(r[dim] || '(blank)'); } }
  const cats = [...catSet].sort();

  // 各カテゴリ系列
  const series = cats.map(c => labels.map(d=>{
    return (byDate.get(d)||[]).filter(r => (r[dim]||'(blank)')===c).reduce((s,r)=>s+r.Amount,0);
  }));

  // 合計ライン
  const totals = labels.map(d=> sumAt(d));

  if(lineChart) lineChart.destroy();
  const ctx = $("lineChart");
  lineChart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets: [
        // カテゴリ（細線）
        ...cats.map((c,i)=>({
          label:c,
          data:series[i],
          tension:0.35,           // 滑らか
          borderWidth:1.5,
          fill:false,
          pointRadius:0,          // 点マーカー非表示（最重要）
          pointHitRadius:8
        })),
        // 合計（白・太線・最前面）
        {
          label:'合計',
          data:totals,
          borderColor:'#ffffff',
          borderWidth:3,
          tension:0.35,
          pointRadius:0,
          pointHitRadius:10,
          order: -1                // 最前面
        }
      ]
    },
    options:{
      responsive:true,
      scales:{
        x:{
          grid:{color:'rgba(255,255,255,0.14)'},
          ticks:{color:'#cfd6e4', autoSkip:true, maxTicksLimit:12}
        },
        y:{
          grid:{color:'rgba(255,255,255,0.14)'},
          ticks:{color:'#cfd6e4', callback:(v)=>'¥'+fmt(v)}
        }
      },
      plugins:{
        legend:{position:'bottom', labels:{color:'#e8ecf1'}},
        tooltip:{callbacks:{label: (ctx)=> `${ctx.dataset.label}: ${yen(ctx.parsed.y)}`}}
      },
      elements:{
        line:{capBezierPoints:true}
      }
    }
  });
}

// ---------- 2日間比較 ----------
let cmpChart;
function drawCmp(){
  if(!DATES.length) return;
  let a = $("cmpDateA").value || DATES.at(-1);
  let b = $("cmpDateB").value || DATES.at(-1);
  a = nearestOnOrBefore(a) || DATES.at(-1);
  b = nearestOnOrBefore(b) || DATES.at(-1);

  const dim = $("cmpDimension").value;

  // カテゴリ全集合
  const set = new Set();
  for(const r of (byDate.get(a)||[])) set.add(r[dim]||'(blank)');
  for(const r of (byDate.get(b)||[])) set.add(r[dim]||'(blank)');
  const cats = [...set];

  const mapSum = (date, cat) => (byDate.get(date)||[]).filter(r=>(r[dim]||'(blank)')===cat).reduce((s,r)=>s+r.Amount,0);
  const valsA = cats.map(c=> mapSum(a,c));
  const valsB = cats.map(c=> mapSum(b,c));

  const labels = cats;
  if(cmpChart) cmpChart.destroy();
  cmpChart = new Chart($("cmpChart"), {
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:`${a}`, data:valsA, borderWidth:0, backgroundColor:'rgba(255,255,255,0.8)'},
        {label:`${b}`, data:valsB, borderWidth:0}
      ]
    },
    options:{
      plugins:{
        legend:{position:'bottom'},
        tooltip:{callbacks:{label:ctx => `${ctx.dataset.label}: ${yen(ctx.parsed.y)}`}}
      },
      responsive:true,
      scales:{
        x:{grid:{color: 'rgba(255,255,255,0.14)'}},
        y:{grid:{color: 'rgba(255,255,255,0.14)'}, ticks:{callback:(v)=>'¥'+fmt(v)}}
      }
    }
  });
  const totalA = valsA.reduce((s,v)=>s+v,0);
  const totalB = valsB.reduce((s,v)=>s+v,0);
  $("cmpNote").textContent = `合計: ${a} = ${yen(totalA)} / ${b} = ${yen(totalB)}（差分: ${(totalB-totalA>=0?'+':'')+yen(totalB-totalA)}）`;
}

// ---------- 月カレンダー ----------
function buildCalendar(){
  const body = $("calBody");
  body.innerHTML = '';
  if(!DATES.length) { $("heatLatest").textContent='—'; return; }

  // 対象月
  const sel = $("calMonth").value;
  const baseMonth = sel ? dayjs(sel+'-01') : dayjs(DATES.at(-1));
  const year = baseMonth.year();
  const month = baseMonth.month(); // 0-based

  // その月の全日
  const firstDay = dayjs(new Date(year, month, 1));
  const lastDay  = dayjs(new Date(year, month+1, 0));
  const startCell = firstDay.day(); // 0:日
  const days = lastDay.date();

  // 月内の記録日・総額・前回比
  const monthDates = DATES.filter(d => dayjs(d).year()===year && dayjs(d).month()===month);
  // 当月に隣接する前回日を辿れるよう全体から prev を計算
  const deltas = new Map(); // date -> {delta, prev}
  for(let i=0;i<DATES.length;i++){
    const d = DATES[i];
    const prev = (i>0)? DATES[i-1] : null;
    const dv = prev ? (sumAt(d) - sumAt(prev)) : 0;
    deltas.set(d, {delta:dv, prev});
  }

  // スケール（当月分で分位）
  const absVals = monthDates.map(d => Math.abs(deltas.get(d)?.delta||0)).filter(v=>v>0).sort((a,b)=>a-b);
  const q = p => (absVals.length? absVals[Math.floor((absVals.length-1)*p)] : 0);
  const t1=q(0.2), t2=q(0.4), t3=q(0.6), t4=q(0.8);

  let cells = [];
  for(let i=0;i<startCell;i++) cells.push(null); // 空白
  for(let d=1; d<=days; d++) cells.push(dayjs(new Date(year, month, d)).format('YYYY-MM-DD'));

  // 行分割して描画
  for(let i=0;i<cells.length; i+=7){
    const tr = document.createElement('tr');
    for(let j=0;j<7; j++){
      const c = cells[i+j];
      const td = document.createElement('td');
      td.className='day';

      if(!c){
        td.style.visibility='hidden';
      }else{
        const dd = dayjs(c).date();
        const total = byDate.has(c)? sumAt(c) : null;
        const info = deltas.get(c);
        const v = Math.abs(info?.delta||0);
        let bg='';
        if(v>0 && v<=t1) bg=' bg1';
        else if(v>t1 && v<=t2) bg=' bg2';
        else if(v>t2 && v<=t3) bg=' bg3';
        else if(v>t3 && v<=t4) bg=' bg4';
        else if(v>t4) bg=' bg5';

        td.className += bg;
        td.title = byDate.has(c)
          ? `${c}\n総額 ${yen(total)}\n前回比 ${(info.delta>=0?'+':'')+yen(info.delta)}${info.prev?`\n（前回: ${info.prev}）`:''}`
          : `${c}\n記録なし`;

        const dateEl = document.createElement('div');
        dateEl.className='date';
        dateEl.textContent = String(dd);

        td.appendChild(dateEl);

        const totalEl = document.createElement('div');
        totalEl.className='total';
        totalEl.textContent = byDate.has(c) ? `総額 ${yen(total)}` : '—';
        td.appendChild(totalEl);

        const deltaEl = document.createElement('div');
        deltaEl.className='delta';
        deltaEl.textContent = byDate.has(c) && info?.prev ? `Δ ${(info.delta>=0?'+':'')+yen(info.delta)}` : '';
        td.appendChild(deltaEl);
      }
      tr.appendChild(td);
    }
    body.appendChild(tr);
  }

  // 直近
  const last = DATES.at(-1);
  const info = deltas.get(last);
  $("heatLatest").textContent = info?.prev
    ? `最新: ${last} 総額 ${yen(sumAt(last))} / 前回比 ${(info.delta>=0?'+':'')+yen(info.delta)}（前回: ${info.prev}）`
    : `最新: ${last} 総額 ${yen(sumAt(last))}`;
}

// ---------- Export ----------
function exportCsv(){
  if(RAW.length===0) return;
  const header = ['Date','Name','Amount','AssetClass','Currency','StockType','Account'];
  const rows = RAW.map(r=>header.map(h=>r[h]??''));
  const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'assets_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ---------- lifecycle ----------
function onDataReady(){
  $("totalDate").value = DATES.at(-1) || '';
  $("fromDate").value  = DATES[0] || '';
  $("toDate").value    = DATES.at(-1) || '';
  $("cmpDateA").value  = DATES.at(-1) || '';
  $("cmpDateB").value  = DATES.at(-1) || '';
  $("calMonth").value  = (DATES.at(-1) || dayjs().format('YYYY-MM-DD')).slice(0,7);

  refreshKPIs();
  drawPie();
  drawLine();
  drawCmp();
  buildCalendar();
}

// events
$("file").addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> parseCSV(reader.result);
  reader.readAsText(file);
});

$("exportCsv").addEventListener('click', exportCsv);

$("totalDate").addEventListener('change', ()=>{
  refreshKPIs();
  drawPie(); // pieの日付も連動
});

$("pieDimension").addEventListener('change', drawPie);

$("lineDimension").addEventListener('change', drawLine);
$("applyRange").addEventListener('click', drawLine);

$("cmpDimension").addEventListener('change', drawCmp);
$("applyCmp").addEventListener('click', drawCmp);

$("calMonth").addEventListener('change', buildCalendar);
</script>
</body>
</html>
